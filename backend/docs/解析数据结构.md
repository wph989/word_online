# 解析数据结构详解

## 概述

本文档详细描述 HTML 解析过程中使用的所有数据结构,包括 Content、StyleSheet 及其相关的子结构。所有数据模型使用 Pydantic 2.0 定义,与前端 TypeScript 类型完全对应。

**数据模型文件**: `app/models/content_models.py`

## 核心数据结构关系图

```
Content
  └── blocks: List[Block]
        ├── ParagraphBlock
        │     ├── id: str
        │     ├── type: "paragraph"
        │     ├── text: str
        │     ├── marks: List[Mark]
        │     └── attrs: ParagraphAttrs (可选)
        ├── HeadingBlock
        ├── TableBlock
        ├── ImageBlock
        ├── CodeBlock
        └── DividerBlock

StyleSheet
  ├── styleId: str
  ├── appliesTo: StyleScope
  └── rules: List[StyleRule]
        ├── target: StyleTarget
        └── style: StyleDeclaration
```

## 一、Mark 类型 (格式标记)

### 1.1 Mark 基类

```python
class BaseMark(BaseModel):
    """Mark 基类"""
    type: str
    range: Tuple[int, int]  # 标记范围 [start, end]
```

**字段说明**:
- `type`: 标记类型(如 "bold", "color")
- `range`: 标记在文本中的范围,左闭右开区间 `[start, end)`

**示例**:
```json
{
  "type": "bold",
  "range": [0, 5]  // 表示文本的第 0-4 个字符加粗
}
```

### 1.2 SimpleMark (简单标记)

```python
class SimpleMark(BaseMark):
    """简单 Mark(无额外属性)"""
    type: Literal["bold", "italic", "underline", "strike", "code", "subscript", "superscript"]
```

**支持的类型**:
- `bold`: 加粗 (`<strong>`, `<b>`)
- `italic`: 斜体 (`<em>`, `<i>`)
- `underline`: 下划线 (`<u>`)
- `strike`: 删除线 (`<s>`, `<strike>`, `<del>`)
- `code`: 行内代码 (`<code>`)
- `subscript`: 下标 (`<sub>`)
- `superscript`: 上标 (`<sup>`)

**示例**:
```json
{
  "type": "bold",
  "range": [0, 5]
}
```

### 1.3 LinkMark (链接标记)

```python
class LinkMark(BaseMark):
    """链接 Mark"""
    type: Literal["link"]
    href: str  # 链接地址
```

**字段说明**:
- `href`: 链接目标地址

**示例**:
```json
{
  "type": "link",
  "range": [0, 10],
  "href": "https://example.com"
}
```

### 1.4 ValueMark (带值标记)

```python
class ValueMark(BaseMark):
    """带值的 Mark(颜色、字号等)"""
    type: Literal["color", "fontSize", "fontFamily", "backgroundColor"]
    value: str  # 样式值
```

**支持的类型**:
- `color`: 文本颜色
- `fontSize`: 字号
- `fontFamily`: 字体
- `backgroundColor`: 背景色

**示例**:
```json
{
  "type": "color",
  "range": [0, 5],
  "value": "rgb(255, 0, 0)"
}
```

```json
{
  "type": "fontSize",
  "range": [0, 5],
  "value": "16px"
}
```

### 1.5 Mark 联合类型

```python
Mark = Union[SimpleMark, LinkMark, ValueMark]
```

**用途**: 在 Block 中使用,支持多种 Mark 类型

## 二、Block 属性

### 2.1 ParagraphAttrs (段落属性)

```python
class ParagraphAttrs(BaseModel):
    """段落属性(包含列表信息)"""
    listType: Optional[Literal["bullet", "ordered", "none"]] = None
    listLevel: Optional[int] = Field(None, ge=0)
    listStart: Optional[int] = None
```

**字段说明**:
- `listType`: 列表类型
  - `"bullet"`: 无序列表(ul)
  - `"ordered"`: 有序列表(ol)
  - `"none"`: 非列表(默认)
- `listLevel`: 列表嵌套层级,从 0 开始
- `listStart`: 有序列表的起始序号(仅 ordered 类型)

**示例**:
```json
// 普通段落
{
  "listType": "none"
}

// 无序列表项
{
  "listType": "bullet",
  "listLevel": 0
}

// 嵌套有序列表项
{
  "listType": "ordered",
  "listLevel": 1,
  "listStart": 1
}
```

## 三、Block 类型

### 3.1 ParagraphBlock (段落块)

```python
class ParagraphBlock(BaseModel):
    """段落 Block"""
    id: str
    type: Literal["paragraph"]
    text: str
    marks: List[Mark] = []
    attrs: Optional[ParagraphAttrs] = None
```

**字段说明**:
- `id`: Block 唯一标识,格式 `para-{uuid}`
- `type`: 固定为 `"paragraph"`
- `text`: 段落文本内容
- `marks`: 格式标记列表
- `attrs`: 段落属性(包含列表信息)

**示例**:
```json
{
  "id": "para-abc123",
  "type": "paragraph",
  "text": "这是一段加粗的文本",
  "marks": [
    {
      "type": "bold",
      "range": [0, 7]
    }
  ],
  "attrs": {
    "listType": "none"
  }
}
```

### 3.2 HeadingBlock (标题块)

```python
class HeadingBlock(BaseModel):
    """标题 Block"""
    id: str
    type: Literal["heading"]
    text: str
    level: Literal[1, 2, 3, 4, 5, 6]
    marks: List[Mark] = []
    attrs: Optional[ParagraphAttrs] = None
```

**字段说明**:
- `level`: 标题层级,1-6 对应 h1-h6

**示例**:
```json
{
  "id": "heading-abc123",
  "type": "heading",
  "level": 1,
  "text": "一级标题",
  "marks": []
}
```

### 3.3 ImageBlock (图片块)

```python
class ImageMeta(BaseModel):
    """图片元信息"""
    width: Optional[Union[int, str]] = None
    height: Optional[Union[int, str]] = None
    alt: Optional[str] = None

class ImageBlock(BaseModel):
    """图片 Block"""
    id: str
    type: Literal["image"]
    src: str
    meta: Optional[ImageMeta] = None
```

**字段说明**:
- `src`: 图片源地址(URL 或 base64)
- `meta`: 图片元信息
  - `width`: 宽度(数字或字符串,如 "100px", "50%")
  - `height`: 高度
  - `alt`: 替代文本

**示例**:
```json
{
  "id": "image-abc123",
  "type": "image",
  "src": "/uploads/image.png",
  "meta": {
    "width": 300,
    "height": 200,
    "alt": "示例图片"
  }
}
```

### 3.4 TableBlock (表格块)

```python
class TableBlock(BaseModel):
    """表格 Block"""
    id: str
    type: Literal["table"]
    data: TableData
    styleId: Optional[str] = None
```

**字段说明**:
- `data`: 表格数据(详见 3.4.1)
- `styleId`: 表格样式 ID 引用

#### 3.4.1 TableData (表格数据)

```python
class TableData(BaseModel):
    """表格数据"""
    rows: int  # 行数
    cols: int  # 列数
    cells: List[TableCellData] = []
    mergeRegions: List[MergeRegion] = []
```

**字段说明**:
- `rows`: 表格总行数
- `cols`: 表格总列数
- `cells`: 单元格数据列表
- `mergeRegions`: 合并单元格区域列表

#### 3.4.2 TableCellData (单元格数据)

```python
class TableCellContent(BaseModel):
    """单元格内容"""
    text: str
    marks: List[Mark] = []

class TableCellData(BaseModel):
    """表格单元格数据"""
    cell: Tuple[int, int]  # 单元格位置 [row, col]
    content: TableCellContent
    styleId: Optional[str] = None
```

**字段说明**:
- `cell`: 单元格位置,格式 `[row, col]`,从 0 开始
- `content`: 单元格内容
  - `text`: 文本内容
  - `marks`: 格式标记
- `styleId`: 单元格样式 ID 引用

**示例**:
```json
{
  "cell": [0, 0],
  "content": {
    "text": "表头",
    "marks": [
      {
        "type": "bold",
        "range": [0, 2]
      }
    ]
  },
  "styleId": "cell-0-0"
}
```

#### 3.4.3 MergeRegion (合并区域)

```python
class MergeRegion(BaseModel):
    """合并单元格区域"""
    id: str
    start: Tuple[int, int]  # 起始位置 [row, col]
    end: Tuple[int, int]    # 结束位置 [row, col]
    masterCell: Tuple[int, int]  # 主单元格位置
    type: Literal["horizontal", "vertical", "rectangular"]
```

**字段说明**:
- `id`: 合并区域唯一标识,格式 `merge-{row}-{col}`
- `start`: 合并区域起始位置(左上角)
- `end`: 合并区域结束位置(右下角)
- `masterCell`: 主单元格位置(保留内容的单元格)
- `type`: 合并类型
  - `"horizontal"`: 横向合并(colspan)
  - `"vertical"`: 纵向合并(rowspan)
  - `"rectangular"`: 矩形合并(rowspan + colspan)

**示例**:
```json
{
  "id": "merge-0-0",
  "start": [0, 0],
  "end": [0, 2],
  "masterCell": [0, 0],
  "type": "horizontal"
}
```

**完整表格示例**:
```json
{
  "id": "table-abc123",
  "type": "table",
  "data": {
    "rows": 2,
    "cols": 3,
    "cells": [
      {
        "cell": [0, 0],
        "content": {"text": "合并单元格", "marks": []},
        "styleId": "cell-0-0"
      },
      {
        "cell": [1, 0],
        "content": {"text": "单元格1", "marks": []}
      },
      {
        "cell": [1, 1],
        "content": {"text": "单元格2", "marks": []}
      },
      {
        "cell": [1, 2],
        "content": {"text": "单元格3", "marks": []}
      }
    ],
    "mergeRegions": [
      {
        "id": "merge-0-0",
        "start": [0, 0],
        "end": [0, 2],
        "masterCell": [0, 0],
        "type": "horizontal"
      }
    ]
  }
}
```

### 3.5 CodeBlock (代码块)

```python
class CodeBlock(BaseModel):
    """代码块 Block"""
    id: str
    type: Literal["code"]
    text: str
    language: Optional[str] = None
```

**字段说明**:
- `text`: 代码内容
- `language`: 编程语言(如 "python", "javascript")

**示例**:
```json
{
  "id": "code-abc123",
  "type": "code",
  "text": "def hello():\n    print('Hello')",
  "language": "python"
}
```

### 3.6 DividerBlock (分割线块)

```python
class DividerBlock(BaseModel):
    """分割线 Block"""
    id: str
    type: Literal["divider"]
```

**示例**:
```json
{
  "id": "divider-abc123",
  "type": "divider"
}
```

### 3.7 Block 联合类型

```python
Block = Union[
    ParagraphBlock, 
    HeadingBlock, 
    ImageBlock, 
    TableBlock, 
    CodeBlock, 
    DividerBlock
]
```

## 四、Content (内容模型)

```python
class Content(BaseModel):
    """Content 模型(文档内容)"""
    blocks: List[Block] = []
```

**字段说明**:
- `blocks`: Block 列表,按文档顺序排列

**示例**:
```json
{
  "blocks": [
    {
      "id": "heading-1",
      "type": "heading",
      "level": 1,
      "text": "文档标题",
      "marks": []
    },
    {
      "id": "para-1",
      "type": "paragraph",
      "text": "这是第一段",
      "marks": []
    },
    {
      "id": "para-2",
      "type": "paragraph",
      "text": "这是第二段",
      "marks": [
        {
          "type": "bold",
          "range": [0, 5]
        }
      ]
    }
  ]
}
```

## 五、StyleSheet (样式表)

### 5.1 StyleScope (样式作用域)

```python
class StyleScope(str, Enum):
    """样式作用域"""
    GLOBAL = "global"      # 全局样式
    DOCUMENT = "document"  # 文档级样式
    CHAPTER = "chapter"    # 章节级样式
```

### 5.2 StyleTarget (样式目标)

```python
class StyleTarget(BaseModel):
    """样式目标选择器"""
    blockType: Optional[Literal[
        "paragraph", "heading", "image", "table", 
        "tableRow", "tableCell", "tableColumn", "tableMerge"
    ]] = None
    listType: Optional[Literal["bullet", "ordered"]] = None
    level: Optional[int] = None
    markType: Optional[Literal["bold", "italic", "underline", "code", "link"]] = None
    scope: Optional[Literal["block", "container", "inline"]] = None
    blockIds: Optional[List[str]] = None
    
    # 表格特定目标
    cellType: Optional[Literal["th", "td"]] = None
    cellPosition: Optional[str] = None
    rowType: Optional[Literal["header", "body", "footer"]] = None
    rowIndex: Optional[Union[Literal["odd", "even"], int]] = None
    columnIndex: Optional[int] = None
    mergeId: Optional[str] = None
```

**字段说明**:
- `blockType`: Block 类型选择器
- `listType`: 列表类型选择器
- `level`: 标题层级选择器
- `blockIds`: 精确命中的 Block ID 列表(最常用)
- `columnIndex`: 表格列索引(用于列宽度样式)
- `cellType`: 单元格类型(th/td)

**示例**:
```json
// 精确匹配 Block
{
  "blockType": "paragraph",
  "blockIds": ["para-1", "para-2"]
}

// 匹配所有一级标题
{
  "blockType": "heading",
  "level": 1
}

// 匹配表格的第 0 列
{
  "blockType": "tableColumn",
  "blockIds": ["table-1"],
  "columnIndex": 0
}

// 匹配特定单元格
{
  "blockType": "tableCell",
  "blockIds": ["cell-0-0"],
  "cellType": "th"
}
```

### 5.3 StyleDeclaration (样式声明)

StyleDeclaration 是多个样式类的组合:

#### 5.3.1 LayoutStyle (布局样式)

```python
class LayoutStyle(BaseModel):
    width: Optional[Union[int, str]] = None
    height: Optional[Union[int, str]] = None
    align: Optional[Literal["left", "center", "right"]] = None
    display: Optional[Literal["block", "inline-block"]] = None
```

#### 5.3.2 TextStyle (文本样式)

```python
class TextStyle(BaseModel):
    fontSize: Optional[int] = None
    fontFamily: Optional[str] = None
    fontWeight: Optional[Union[int, str]] = None
    lineHeight: Optional[float] = None
    color: Optional[str] = None
    textAlign: Optional[Literal["left", "center", "right", "justify"]] = None
    textIndent: Optional[int] = None
    letterSpacing: Optional[float] = None
    backgroundColor: Optional[str] = None
```

#### 5.3.3 BorderStyle (边框样式)

```python
class BorderStyle(BaseModel):
    borderWidth: Optional[int] = None
    borderStyle: Optional[Literal["solid", "dashed", "dotted", "double"]] = None
    borderColor: Optional[str] = None
    borderRadius: Optional[int] = None
    
    # 四边独立控制
    borderTopWidth: Optional[int] = None
    borderTopStyle: Optional[str] = None
    borderTopColor: Optional[str] = None
    # ... 其他边
```

#### 5.3.4 SpacingStyle (间距样式)

```python
class SpacingStyle(BaseModel):
    marginTop: Optional[int] = None
    marginBottom: Optional[int] = None
    paddingTop: Optional[int] = None
    paddingBottom: Optional[int] = None
    paddingLeft: Optional[int] = None
    paddingRight: Optional[int] = None
    padding: Optional[Union[str, int]] = None
    
    minWidth: Optional[Union[str, int]] = None
    maxWidth: Optional[Union[str, int]] = None
    minHeight: Optional[Union[str, int]] = None
```

#### 5.3.5 TableStyle (表格样式)

```python
class TableStyle(BaseModel):
    borderCollapse: Optional[Literal["collapse", "separate"]] = None
    tableLayout: Optional[Literal["auto", "fixed"]] = None
    cellSpacing: Optional[str] = None
    cellPadding: Optional[str] = None
```

#### 5.3.6 CellStyle (单元格样式)

```python
class CellStyle(BaseModel):
    verticalAlign: Optional[Literal["top", "middle", "bottom"]] = None
```

#### 5.3.7 组合样式

```python
class StyleDeclaration(
    LayoutStyle, 
    TextStyle, 
    BorderStyle, 
    SpacingStyle, 
    TableStyle, 
    CellStyle
):
    """样式声明(组合所有样式类型)"""
    pass
```

**示例**:
```json
{
  "textAlign": "center",
  "fontSize": 16,
  "color": "#333",
  "lineHeight": 1.5,
  "marginTop": 10,
  "marginBottom": 10
}
```

### 5.4 StyleRule (样式规则)

```python
class StyleRule(BaseModel):
    """样式规则"""
    target: StyleTarget
    style: StyleDeclaration
```

**示例**:
```json
{
  "target": {
    "blockType": "paragraph",
    "blockIds": ["para-1"]
  },
  "style": {
    "textAlign": "center",
    "fontSize": 16
  }
}
```

### 5.5 StyleSheet (样式表)

```python
class StyleSheet(BaseModel):
    """样式表"""
    styleId: str
    appliesTo: StyleScope
    rules: List[StyleRule] = []
```

**字段说明**:
- `styleId`: 样式表唯一标识,格式 `style-{uuid}`
- `appliesTo`: 样式作用域
- `rules`: 样式规则列表

**完整示例**:
```json
{
  "styleId": "style-abc123",
  "appliesTo": "chapter",
  "rules": [
    {
      "target": {
        "blockType": "paragraph",
        "blockIds": ["para-1"]
      },
      "style": {
        "textAlign": "center",
        "fontSize": 16
      }
    },
    {
      "target": {
        "blockType": "heading",
        "blockIds": ["heading-1"],
        "level": 1
      },
      "style": {
        "fontSize": 24,
        "fontWeight": "bold",
        "color": "#000"
      }
    },
    {
      "target": {
        "blockType": "tableColumn",
        "blockIds": ["table-1"],
        "columnIndex": 0
      },
      "style": {
        "width": "100"
      }
    },
    {
      "target": {
        "blockType": "tableCell",
        "blockIds": ["cell-0-0"],
        "cellType": "th"
      },
      "style": {
        "textAlign": "center",
        "backgroundColor": "#f0f0f0",
        "fontWeight": "bold"
      }
    }
  ]
}
```

## 六、数据验证规则

### 6.1 ID 格式
- **ParagraphBlock**: `para-{uuid}`
- **HeadingBlock**: `heading-{uuid}`
- **TableBlock**: `table-{uuid}`
- **ImageBlock**: `image-{uuid}`
- **CodeBlock**: `code-{uuid}`
- **DividerBlock**: `divider-{uuid}`
- **MergeRegion**: `merge-{row}-{col}`
- **StyleSheet**: `style-{uuid}`

### 6.2 范围验证
- **Mark.range**: `[start, end]`,满足 `0 <= start < end <= len(text)`
- **TableCellData.cell**: `[row, col]`,满足 `0 <= row < rows` 和 `0 <= col < cols`
- **MergeRegion**: `start <= end`

### 6.3 类型约束
- **HeadingBlock.level**: 1-6
- **ParagraphAttrs.listLevel**: >= 0
- **TableData.rows, cols**: >= 0

## 七、数据使用示例

### 7.1 创建 Content

```python
from app.models.content_models import Content, ParagraphBlock, SimpleMark

# 创建段落
para = ParagraphBlock(
    id="para-1",
    type="paragraph",
    text="Hello World",
    marks=[
        SimpleMark(type="bold", range=(0, 5))
    ]
)

# 创建 Content
content = Content(blocks=[para])

# 序列化为 JSON
content_json = content.model_dump()
```

### 7.2 创建 StyleSheet

```python
from app.models.content_models import (
    StyleSheet, StyleRule, StyleTarget, StyleDeclaration, StyleScope
)

# 创建样式规则
rule = StyleRule(
    target=StyleTarget(
        blockType="paragraph",
        blockIds=["para-1"]
    ),
    style=StyleDeclaration(
        textAlign="center",
        fontSize=16
    )
)

# 创建 StyleSheet
stylesheet = StyleSheet(
    styleId="style-1",
    appliesTo=StyleScope.CHAPTER,
    rules=[rule]
)

# 序列化为 JSON
stylesheet_json = stylesheet.model_dump()
```

### 7.3 从 JSON 解析

```python
import json
from app.models.content_models import Content, StyleSheet

# 从 JSON 字符串解析
content_dict = json.loads(content_json_str)
content = Content(**content_dict)

stylesheet_dict = json.loads(stylesheet_json_str)
stylesheet = StyleSheet(**stylesheet_dict)
```

## 八、数据模型优势

1. **类型安全**: Pydantic 提供运行时类型验证
2. **自动文档**: 模型自带文档字符串和字段描述
3. **序列化**: 自动支持 JSON 序列化和反序列化
4. **验证**: 自动验证数据格式和约束
5. **IDE 支持**: 完整的类型提示和自动补全
6. **前后端一致**: 与 TypeScript 类型定义对应

## 九、注意事项

1. **ID 唯一性**: 确保每个 Block 的 ID 在 Content 中唯一
2. **Range 准确性**: Mark 的 range 必须在文本范围内
3. **引用完整性**: styleId 必须在 StyleSheet 中存在对应的规则
4. **数据一致性**: 表格的 cells 和 mergeRegions 必须一致
5. **可选字段**: 使用 `Optional` 标记可选字段,避免必填错误

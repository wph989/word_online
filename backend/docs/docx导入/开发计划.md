# DOCX 导入功能开发计划

> 本文档作为开发进度追踪清单，每完成一个任务请勾选对应复选框。

---

## 阶段一：环境准备

### 1.1 依赖安装
- [x] 在 `requirements.txt` 中添加 `python-docx>=1.1.0`
- [x] 执行 `pip install -r requirements.txt` 安装依赖
- [x] 验证安装: `python -c "import docx; print(docx.__version__)"` → 1.1.0

### 1.2 配置文件更新
- [x] 在 `.env.example` 中添加 DOCX 导入配置项
- [x] 在 `.env` 中添加实际配置值 (用户自行复制)
- [x] 创建配置读取模块 `app/services/docx_importer/config.py`

---

## 阶段二：核心服务开发

### 2.1 创建模块目录结构
- [x] 创建目录 `app/services/docx_importer/`
- [x] 创建 `__init__.py` 导出入口

### 2.2 DOCX 解析器 (parser.py)
- [x] 创建 `DocxParser` 类基础结构
- [x] 实现 `_parse_paragraph()` - 段落解析
- [x] 实现 `_parse_run()` - Run 格式提取
- [x] 实现 `_get_heading_level()` - 标题识别
- [x] 实现 `_parse_table()` - 表格解析
- [x] 实现 `_extract_column_widths()` - 列宽提取
- [x] 实现 `_extract_merge_regions()` - 合并单元格提取
- [x] 实现 `_extract_cell_styles()` - 单元格样式提取
- [x] 实现 `_parse_list()` - 列表解析
- [x] 实现 `_extract_images()` - 图片提取
- [x] 实现 `_get_page_settings()` - 页面设置提取
- [ ] 编写单元测试验证解析器

### 2.3 元素转换器 (element_converter.py)
- [x] 创建 `ElementConverter` 类
- [x] 实现 `convert_paragraph()` - 段落转 ParagraphBlock
- [x] 实现 `convert_heading()` - 标题转 HeadingBlock
- [x] 实现 `_convert_marks()` - Run 格式转 Mark 列表
- [x] 实现 `_convert_paragraph_style()` - 段落样式转 StyleRule
- [x] 实现 `convert_table()` - 表格转 TableBlock
- [x] 实现 `_convert_table_styles()` - 表格样式转 StyleRule 列表
- [x] 实现 `_convert_cell_styles()` - 单元格样式转换
- [x] 实现 `convert_list_item()` - 列表项转换
- [x] 实现 `convert_image()` - 图片转 ImageBlock
- [ ] 编写单元测试验证转换器

### 2.4 图片提取器 (image_extractor.py)
- [x] 创建 `ImageExtractor` 类
- [x] 实现 `extract_and_save()` - 提取并保存图片
- [x] 实现图片命名和去重逻辑
- [x] 实现路径映射返回
- [ ] 编写单元测试验证图片提取

### 2.5 章节构建器 (chapter_builder.py)
- [x] 创建 `ChapterBuilder` 类
- [x] 实现 `build()` - 主构建方法
- [x] 实现标题级别判断逻辑
- [x] 实现父章节关系计算
- [x] 实现默认章节创建逻辑
- [x] 实现首内容非标题处理
- [x] 实现 order_index 计算
- [ ] 编写单元测试验证章节构建

### 2.6 主导入类 (importer.py)
- [x] 创建 `DocxImporter` 类
- [x] 实现文件验证逻辑
- [x] 实现 `import_document()` 主流程
- [x] 整合各子模块调用
- [x] 实现数据库事务处理
- [x] 实现错误处理和回滚
- [ ] 编写集成测试

---

## 阶段三：API 接口开发

### 3.1 Schema 定义
- [x] 在 `models/schemas.py` 添加 `ImportChapterInfo`
- [x] 在 `models/schemas.py` 添加 `ImportResponse`

### 3.2 API 路由
- [x] 创建 `api/v1/docx_import.py` 文件
- [x] 实现 `POST /api/v1/documents/import` 接口
- [x] 实现文件类型验证
- [x] 实现文件大小验证
- [x] 实现参数处理（max_heading_level, document_title）
- [x] 实现错误响应处理

### 3.3 路由注册
- [x] 在 `main.py` 中注册新路由
- [ ] 验证 API 文档显示正确（访问 /docs）

---

## 阶段四：测试验证

### 4.1 单元测试
- [ ] 创建测试文件 `tests/test_docx_importer.py`
- [ ] 测试: 简单段落解析
- [ ] 测试: 格式化文本（加粗、斜体、颜色等）
- [ ] 测试: 标题级别识别
- [ ] 测试: 表格解析（行列数）
- [ ] 测试: 表格列宽提取
- [ ] 测试: 合并单元格提取
- [ ] 测试: 列表解析
- [ ] 测试: 按 H1 分章节
- [ ] 测试: 按 H1+H2 分章节
- [ ] 测试: 无标题时创建默认章节
- [ ] 测试: 首内容非标题处理
- [ ] 测试: 图片提取

### 4.2 集成测试
- [ ] 准备测试 DOCX 文件（包含各种格式）
- [ ] 测试完整导入流程
- [ ] 验证数据库记录正确
- [ ] 验证图片文件保存正确
- [ ] 验证章节层级结构正确

### 4.3 API 测试
- [ ] 使用 curl/Postman 测试导入接口
- [ ] 测试成功导入响应
- [ ] 测试错误文件类型响应
- [ ] 测试文件过大响应
- [ ] 测试参数校验

### 4.4 端到端验证
- [ ] 导入 DOCX 后通过现有 API 获取章节
- [ ] 验证前端编辑器能正确渲染导入内容
- [ ] 验证格式与原文档一致

---

## 阶段五：文档和收尾

### 5.1 文档更新
- [ ] 更新 API 文档说明
- [ ] 在 README 中添加功能说明

### 5.2 代码审查
- [ ] 检查代码风格一致性
- [ ] 检查错误处理完整性
- [ ] 检查日志记录
- [ ] 检查类型注解完整性

### 5.3 最终验收
- [ ] 全量测试通过
- [ ] 功能演示验收

---

## 进度统计

| 阶段 | 总任务数 | 已完成 | 进度 |
|------|---------|--------|------|
| 阶段一：环境准备 | 6 | 6 | 100% |
| 阶段二：核心服务 | 32 | 28 | 87.5% |
| 阶段三：API 接口 | 10 | 9 | 90% |
| 阶段四：测试验证 | 18 | 0 | 0% |
| 阶段五：文档收尾 | 7 | 0 | 0% |
| **总计** | **73** | **43** | **59%** |

---

## 开发顺序建议

```
1. 环境准备 (1.1 → 1.2)
         ↓
2. 解析器开发 (2.1 → 2.2)
         ↓
3. 转换器开发 (2.3)
         ↓
4. 图片提取器 (2.4)
         ↓
5. 章节构建器 (2.5)
         ↓
6. 主导入类 (2.6)
         ↓
7. API 接口 (3.1 → 3.2 → 3.3)
         ↓
8. 测试验证 (4.1 → 4.2 → 4.3 → 4.4)
         ↓
9. 文档收尾 (5.1 → 5.2 → 5.3)
```

---

## 备注

- 每完成一个子任务，将 `[ ]` 改为 `[x]`
- 更新进度统计表中的"已完成"数量
- 遇到问题在对应任务下方添加备注

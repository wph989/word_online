# DOCX 文件导入功能需求文档

## 1. 功能概述

实现通过 API 接口导入 DOCX 文件，后端解析文件结构并根据标题自动创建章节，将内容和样式按现有数据格式存入数据库。

### 1.1 核心目标

- **1:1 还原**: 完整保留 DOCX 文件的内容和格式
- **自动分章**: 根据配置的标题级别自动创建章节
- **格式转换**: 将 DOCX 结构转换为项目现有的 Content/StyleSheet JSON 格式

---

## 2. 功能详细需求

### 2.1 接口设计

| 项目 | 说明 |
|------|------|
| 请求方式 | `POST /api/v1/documents/import` |
| Content-Type | `multipart/form-data` |
| 认证 | 无（与现有接口保持一致） |

**请求参数:**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `file` | File | 是 | DOCX 文件 |
| `max_heading_level` | int | 否 | 最大章节标题级别（1-6），默认从配置文件读取 |
| `document_title` | string | 否 | 文档标题，默认使用文件名 |

**响应示例:**

```json
{
  "doc_id": "uuid-string",
  "title": "文档标题",
  "chapters": [
    {
      "id": "chapter-uuid",
      "title": "章节标题",
      "level": 1,
      "order_index": 0
    }
  ],
  "message": "导入成功，共创建 N 个章节"
}
```

### 2.2 章节创建规则

#### 2.2.1 标题级别配置

- **配置来源**: 优先使用接口参数 `max_heading_level`，否则使用配置文件默认值
- **配置含义**: 设置为 N 表示 H1 ~ HN 级标题会创建为独立章节

**示例**: `max_heading_level = 2`

| DOCX 元素 | 处理方式 |
|-----------|----------|
| H1 标题 | 创建一级章节 |
| H2 标题 | 创建二级章节（父节点为上一个 H1） |
| H3+ 标题 | 作为章节内容（HeadingBlock） |
| 正文段落 | 作为章节内容（ParagraphBlock） |

#### 2.2.2 特殊情况处理

| 场景 | 处理方式 |
|------|----------|
| 无标题文档 | 创建一个默认章节，标题为"默认章节" |
| 首内容非标题 | 创建默认章节存放标题前的内容 |
| 连续同级标题 | 每个标题创建独立章节 |

#### 2.2.3 章节层级示例

```
DOCX 结构:                          章节结构 (max_heading_level=2):
├─ H1: 第一章                       ├─ 章节: 第一章 (level=1)
│   ├─ 段落内容                     │   └─ content: [段落, H3标题, 段落...]
│   ├─ H3: 小节标题                 │
│   └─ 段落内容                     │
├─ H2: 第一节                       ├─ 章节: 第一节 (level=2, parent=第一章)
│   └─ 段落内容                     │   └─ content: [段落...]
├─ H1: 第二章                       ├─ 章节: 第二章 (level=1)
│   └─ 段落内容                     │   └─ content: [段落...]
```

---

## 3. 格式还原规范

### 3.1 文本格式

| DOCX 属性 | 对应 Mark 类型 | 存储字段 |
|-----------|---------------|----------|
| 加粗 (Bold) | `SimpleMark: bold` | marks[].type |
| 斜体 (Italic) | `SimpleMark: italic` | marks[].type |
| 下划线 (Underline) | `SimpleMark: underline` | marks[].type |
| 删除线 (Strike) | `SimpleMark: strike` | marks[].type |
| 上标 (Superscript) | `SimpleMark: superscript` | marks[].type |
| 下标 (Subscript) | `SimpleMark: subscript` | marks[].type |
| 字体颜色 | `ValueMark: color` | marks[].value |
| 字号 | `ValueMark: fontSize` | marks[].value |
| 字体 | `ValueMark: fontFamily` | marks[].value |
| 背景色 | `ValueMark: backgroundColor` | marks[].value |
| 超链接 | `LinkMark: link` | marks[].href |

### 3.2 段落格式

| DOCX 属性 | StyleSheet 字段 | 说明 |
|-----------|-----------------|------|
| 对齐方式 | `textAlign` | left/center/right/justify |
| 首行缩进 | `textIndent` | 支持 em/px 单位 |
| 行间距 | `lineHeight` | 倍数或固定值 |
| 段前间距 | `marginTop` | px 单位 |
| 段后间距 | `marginBottom` | px 单位 |

### 3.3 表格格式

| DOCX 属性 | 存储位置 | 说明 |
|-----------|----------|------|
| 列宽 | StyleSheet → tableColumn | 每列宽度 |
| 单元格合并 | Content → TableData.mergeRegions | colspan/rowspan |
| 单元格背景色 | StyleSheet → tableCell.backgroundColor | 背景色 |
| 单元格对齐 | StyleSheet → tableCell.textAlign/verticalAlign | 水平/垂直对齐 |
| 单元格边框 | StyleSheet → tableCell.border* | 边框样式 |

### 3.4 列表格式

| DOCX 属性 | 存储位置 | 说明 |
|-----------|----------|------|
| 有序列表 | ParagraphAttrs.listType = "ordered" | ol |
| 无序列表 | ParagraphAttrs.listType = "bullet" | ul |
| 列表层级 | ParagraphAttrs.listLevel | 从 0 开始 |
| 起始序号 | ParagraphAttrs.listStart | 仅有序列表 |

### 3.5 图片处理

| 处理项 | 说明 |
|--------|------|
| 提取方式 | 从 DOCX 压缩包中提取嵌入图片 |
| 存储位置 | `uploads/images/{doc_id}/{image_name}` |
| 路径格式 | `/api/v1/assets/images/{doc_id}/{image_name}` |
| Content 存储 | ImageBlock.src = 图片访问路径 |
| 尺寸保留 | ImageBlock.meta.width/height |

### 3.6 页面设置 → DocumentSettings

| DOCX 属性 | DocumentSettings 字段 |
|-----------|----------------------|
| 上边距 | margin_top |
| 下边距 | margin_bottom |
| 左边距 | margin_left |
| 右边距 | margin_right |

### 3.7 暂不支持的格式

| 格式类型 | 处理方式 |
|----------|----------|
| 页眉页脚 | 忽略 |
| 分页符/分节符 | 忽略 |
| 批注/修订 | 忽略 |
| 形状/SmartArt | 忽略 |
| 公式 | 忽略 |
| 脚注/尾注 | 忽略 |

---

## 4. 配置文件

在 `.env` 或配置文件中添加:

```ini
# DOCX 导入默认配置
DOCX_IMPORT_MAX_HEADING_LEVEL=2
DOCX_IMPORT_DEFAULT_CHAPTER_TITLE=默认章节
```

---

## 5. 错误处理

| 错误场景 | HTTP 状态码 | 错误信息 |
|----------|-------------|----------|
| 文件格式不正确 | 400 | 仅支持 .docx 格式文件 |
| 文件损坏 | 400 | 文件已损坏，无法解析 |
| 文件过大 | 413 | 文件大小超过限制（{max_size}MB） |
| 解析失败 | 500 | 文档解析失败: {具体原因} |

---

## 6. 数据流程

```
┌─────────┐    ┌──────────────┐    ┌───────────────┐    ┌──────────┐
│  DOCX   │───▶│ DocxParser   │───▶│ ChapterBuilder│───▶│ Database │
│  File   │    │              │    │               │    │          │
└─────────┘    └──────────────┘    └───────────────┘    └──────────┘
                     │                     │
                     ▼                     ▼
              ┌──────────────┐    ┌───────────────┐
              │ 提取图片     │    │ 生成 Content  │
              │ 保存到磁盘   │    │ + StyleSheet  │
              └──────────────┘    └───────────────┘
```

### 6.1 处理步骤

1. **接收文件**: 验证文件格式和大小
2. **解析 DOCX**: 使用 python-docx 库解析文档结构
3. **提取图片**: 保存嵌入图片到 uploads 目录
4. **构建章节**: 按标题级别配置拆分内容
5. **格式转换**: 将每个章节内容转换为 Content + StyleSheet JSON
6. **创建记录**: 创建 Document、Chapters、DocumentSettings 数据库记录

---

## 7. 技术方案

### 7.1 依赖库

```
python-docx>=1.1.0
```

### 7.2 模块设计

| 模块 | 职责 |
|------|------|
| `services/docx_importer/parser.py` | DOCX 文件解析，元素提取 |
| `services/docx_importer/chapter_builder.py` | 按标题拆分章节 |
| `services/docx_importer/format_converter.py` | 格式转换为 Content/StyleSheet |
| `services/docx_importer/image_extractor.py` | 图片提取与保存 |
| `api/v1/import.py` | 导入 API 接口 |

---

## 8. 验收标准

- [ ] 能成功上传并导入 .docx 文件
- [ ] 根据配置的标题级别正确创建章节层级结构
- [ ] 文本格式（字体、字号、颜色、加粗等）完整保留
- [ ] 段落格式（对齐、缩进、间距）完整保留
- [ ] 表格结构（列宽、合并单元格、样式）完整保留
- [ ] 列表格式（有序/无序、层级）完整保留
- [ ] 图片正确提取并可访问
- [ ] 页面设置正确导入到 DocumentSettings
- [ ] 无标题文档能创建默认章节
- [ ] 错误场景返回正确的错误信息
